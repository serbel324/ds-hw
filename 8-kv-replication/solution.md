# Решение

### Контекст запроса
Структура `RequestContext`, хранящаяся на ноде, на которую пришел запрос PUT/GET/DELETE. Структура хранит следующие поля:
 - `node_id` - id ноды, на которую пришел запрос
 - `nodes` - список всех нод
 - `key`, `value`, `quorum` - берутся из сообщения запроса, `value = None` для запросов GET и DELETE
 - `context` - контекст записи, в смысле аргумент функции `put(key, value, context)`, в нашем случае равен времени, когда был получен запрос
 - `acks`, `responses`, `ack_replicas`, `missing_replicas`, `extra_replicas` - информация о том, какие из узлов, на которые совершалась запись, дали ответ на сообщения
 - `delivered` - был ли отправлен ответ на запрос клиента
 - `synchronized` - была ли операция совершена на всех 3 репликах, без учета экстра-реплик (на которые идет запись при недоступности 3 базовых)
 - `final_context`, `final_value` - значения на момент отправки ответа
 - `replica_idxs`, `replicas` - ноды, на которые идет запись реплик (будем называть это базовыми нодами)
 - `next_replica_idx` - индекс ноды, на которую будет идти запись, если базовые реплики недоступны (будем называть это экстра-нодами)

### Получение запроса клиента
1. Создаем контекст запроса
2. Отправляем сообщения на базовые реплики

### Получили ACK
1. Если отправитель ACK'а уже отправлял ACK, игнорируем это сообщение
2. Если отправитель ACK'а - базовая нода:
  1. Обновляем список `ack_replicas`
  2. Если мы получили ACK'и со всех 3 базовых нод, выставляем `synchronised=True` и удаляем записи с экстра-нод
3. Если `synchronised=True` и отправитель ACK'а - экстра-нода, удалим данные с этой ноды
4. Если `delivered=True` (на запрос уже дсотавлен ответ) и запрос==GET и полученное значение старее, чем доставленное, и нода является базовой, то исправим значение на доставленное
  1. Проходимся по полученным ответам, выбираем самый новый из них, записываем `final_value`, `final_context`
  2. На все устаревшие ноды отправляем новое значение
  3. Доставляем ответ клиенту

### Получили NACK
Считаем, что NACK - если ответ на сообщение не был получен в течении 0.5 с
1. Если `delivered=True` - игнорируем
2. Если NACK от экстра-ноду - пробуем записать на следующую экстра-ноду
3. Если NACK от базовой ноду, то отправляем запрос заново, а если NACK от этой ноды получен впервые, то дополнительно отправляем запрос на экстра-ноду

### Как обрабатываем сообщения на нодах
Применяем изменения только если `context` новее записанного по ключу, отправляем ACK, если это не запрос починки